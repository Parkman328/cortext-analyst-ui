<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cortex Analyst UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #009845 0%, #006937 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-green-100 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-brain text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Cortex Analyst UI</h1>
                        <p class="text-sm opacity-90">Process questions through Snowflake Cortex Analyst</p>
                    </div>
                </div>
                <div id="connectionStatus" class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full bg-red-400" id="statusDot"></div>
                    <span class="text-sm" id="statusText">Not Connected</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Configuration Card -->
        <div class="bg-white rounded-lg card-shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-cog mr-2 text-indigo-600"></i>
                Snowflake Configuration
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input type="text" id="account" placeholder="Account (e.g., abc123.us-east-1)"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                
                <input type="text" id="user" placeholder="Username"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                
                <input type="password" id="password" placeholder="Password"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                
                <input type="text" id="warehouse" placeholder="Warehouse"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                
                <input type="text" id="database" placeholder="Database" 
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                
                <input type="text" id="schema" placeholder="Schema" 
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>
            
            <input type="text" id="semantic_model" 
                placeholder="Semantic Model Path" 
                
                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4">
            
            <button onclick="configureConnection()" 
                class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90 transition">
                <i class="fas fa-plug mr-2"></i>Configure Connection
            </button>
        </div>

        <!-- Upload Card -->
        <div class="bg-white rounded-lg card-shadow p-6 mb-6" id="uploadCard">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-upload mr-2 text-indigo-600"></i>
                Upload Questions CSV
            </h2>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    CSV should have columns: <code class="bg-gray-100 px-2 py-1 rounded">Id</code> and 
                    <code class="bg-gray-100 px-2 py-1 rounded">Question</code>
                </p>
            </div>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-500 transition"
                id="dropZone">
                <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 mb-4">Drag & drop your CSV file here or</p>
                <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('csvFile').click()"
                    class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                    Browse Files
                </button>
                <p class="text-xs text-gray-500 mt-4" id="fileName"></p>
            </div>
            
            <button onclick="uploadFile()" id="uploadBtn" disabled
                class="mt-4 w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed">
                <i class="fas fa-paper-plane mr-2"></i>Start Processing
            </button>
        </div>

        <!-- Processing Status Card -->
        <div class="bg-white rounded-lg card-shadow p-6 mb-6 hidden" id="statusCard">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-tasks mr-2 text-indigo-600"></i>
                Processing Status
            </h2>
            
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-2">
                    <span id="progressText">0 / 0</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div class="bg-indigo-600 h-4 rounded-full progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Processed</div>
                    <div class="text-2xl font-bold text-blue-600" id="processedCount">0</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Successful</div>
                    <div class="text-2xl font-bold text-green-600" id="successCount">0</div>
                </div>
                <div class="bg-red-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Failed</div>
                    <div class="text-2xl font-bold text-red-600" id="failedCount">0</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-600">Error 392708</div>
                    <div class="text-2xl font-bold text-yellow-600" id="error392708Count">0</div>
                </div>
            </div>
            
            <div class="flex space-x-4" id="downloadButtons" style="display: none;">
                <button onclick="downloadResults('json')" 
                    class="flex-1 bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                    <i class="fas fa-download mr-2"></i>Download JSON
                </button>
                <button onclick="downloadResults('csv')" 
                    class="flex-1 bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                    <i class="fas fa-download mr-2"></i>Download CSV
                </button>
            </div>
        </div>

        <!-- Jobs History -->
        <div class="bg-white rounded-lg card-shadow p-6">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-history mr-2 text-indigo-600"></i>
                Recent Jobs
            </h2>
            <div id="jobsList" class="space-y-2">
                <p class="text-gray-500 text-center py-4">No jobs yet</p>
            </div>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let statusCheckInterval = null;
        let selectedFile = null;

        // Drag and drop handlers
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.csv')) {
                selectedFile = files[0];
                document.getElementById('fileName').textContent = files[0].name;
                document.getElementById('uploadBtn').disabled = false;
            }
        });

        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                document.getElementById('fileName').textContent = selectedFile.name;
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        async function loadConfiguration() {
            try {
                const response = await fetch('/api/configure');
                const config = await response.json();
                
                // Populate all form fields with default values
                document.getElementById('account').value = config.account || '';
                document.getElementById('user').value = config.user || '';
                document.getElementById('password').value = config.password || '';
                document.getElementById('warehouse').value = config.warehouse || '';
                document.getElementById('database').value = config.database || '';
                document.getElementById('schema').value = config.schema_name || '';
                document.getElementById('semantic_model').value = config.semantic_model || '';
                
                console.log('Configuration loaded successfully');
            } catch (error) {
                console.error('Failed to load configuration:', error);
            }
        }
        async function configureConnection() {
            const config = {
                account: document.getElementById('account').value,
                user: document.getElementById('user').value,
                password: document.getElementById('password').value,
                warehouse: document.getElementById('warehouse').value,
                database: document.getElementById('database').value,
                schema: document.getElementById('schema').value,
                semantic_model: document.getElementById('semantic_model').value
            };

            try {
                const response = await fetch('/api/configure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('statusDot').className = 'w-3 h-3 rounded-full bg-green-400';
                    document.getElementById('statusText').textContent = 'Connected';
                    showNotification('Connected to Snowflake successfully!', 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showNotification('Connection failed: ' + error.message, 'error');
            }
        }

        async function uploadFile() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Uploading...';

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentJobId = result.job_id;
                    showNotification(`Processing started for ${result.num_questions} questions`, 'success');
                    
                    // Show status card
                    document.getElementById('statusCard').classList.remove('hidden');
                    
                    // Start status polling
                    startStatusPolling();
                    
                    // Load jobs list
                    loadJobs();
                } else {
                    throw new Error(result.detail || 'Upload failed');
                }
            } catch (error) {
                showNotification('Upload failed: ' + error.message, 'error');
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Start Processing';
            }
        }

        function startStatusPolling() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(checkStatus, 2000);
            checkStatus(); // Check immediately
        }

        async function checkStatus() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/api/status/${currentJobId}`);
                const status = await response.json();

                // Update progress
                document.getElementById('progressText').textContent = `${status.processed} / ${status.total}`;
                document.getElementById('progressPercent').textContent = `${status.progress_percent}%`;
                document.getElementById('progressBar').style.width = `${status.progress_percent}%`;

                // Update counts
                document.getElementById('processedCount').textContent = status.processed;
                document.getElementById('successCount').textContent = status.successful;
                document.getElementById('failedCount').textContent = status.failed;
                document.getElementById('error392708Count').textContent = status.error_392708;

                if (status.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    document.getElementById('downloadButtons').style.display = 'flex';
                    document.getElementById('uploadBtn').disabled = false;
                    document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Start Processing';
                    showNotification('Processing completed!', 'success');
                    loadJobs();
                } else if (status.status === 'failed') {
                    clearInterval(statusCheckInterval);
                    showNotification('Processing failed: ' + (status.error || 'Unknown error'), 'error');
                    document.getElementById('uploadBtn').disabled = false;
                    document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Start Processing';
                }
            } catch (error) {
                console.error('Status check failed:', error);
            }
        }

        async function downloadResults(format) {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/api/results/${currentJobId}/${format}`);
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `results_${currentJobId}.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showNotification(`Downloaded ${format.toUpperCase()} file`, 'success');
            } catch (error) {
                showNotification('Download failed: ' + error.message, 'error');
            }
        }

        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs');
                const data = await response.json();
                
                const jobsList = document.getElementById('jobsList');
                
                if (data.jobs.length === 0) {
                    jobsList.innerHTML = '<p class="text-gray-500 text-center py-4">No jobs yet</p>';
                    return;
                }
                
                jobsList.innerHTML = data.jobs.map(job => `
                    <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50">
                        <div class="flex-1">
                            <div class="font-semibold">${job.job_id.substring(0, 8)}...</div>
                            <div class="text-sm text-gray-600">
                                ${job.successful} successful, ${job.failed} failed
                                ${job.completed_at ? '• Completed' : '• ' + job.status}
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            ${job.status === 'completed' ? `
                                <button onclick="downloadJobResults('${job.job_id}', 'json')" 
                                    class="px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">
                                    JSON
                                </button>
                                <button onclick="downloadJobResults('${job.job_id}', 'csv')" 
                                    class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">
                                    CSV
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        }

        async function downloadJobResults(jobId, format) {
            try {
                const response = await fetch(`/api/results/${jobId}/${format}`);
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `results_${jobId}.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                showNotification('Download failed: ' + error.message, 'error');
            }
        }

        function showNotification(message, type) {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Load configuration on page load
        loadConfiguration();
        
        // Load jobs on page load
        loadJobs();
        setInterval(loadJobs, 10000); // Refresh every 10 seconds
    </script>
</body>
</html>
